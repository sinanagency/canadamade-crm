<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <title>Staff Portal | CanadaMade</title>
  <link rel="icon" type="image/png" href="/logo.png">
  <link rel="apple-touch-icon" href="/logo.png">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #000000;
      --card: #0a0a0a;
      --card-hover: #111111;
      --border: #1a1a1a;
      --text: #ffffff;
      --text-dim: #888888;
      --text-muted: #555555;
      --red: #E31837;
      --green: #22c55e;
      --yellow: #eab308;
      --blue: #3b82f6;
      --purple: #8b5cf6;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
    }

    /* ===== PIN SCREEN ===== */
    #pinScreen {
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: linear-gradient(180deg, #000 0%, #0a0a0a 100%);
    }

    #pinScreen.hidden { display: none; }

    .pin-brand {
      text-align: center;
      margin-bottom: 48px;
    }

    .pin-logo {
      width: 80px;
      height: 80px;
      margin-bottom: 16px;
    }

    .pin-brand h1 {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .pin-brand p {
      font-size: 14px;
      color: var(--text-dim);
      margin-top: 4px;
    }

    .pin-display {
      display: flex;
      gap: 20px;
      margin-bottom: 48px;
    }

    .pin-digit {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #222;
      transition: all 0.15s ease;
    }

    .pin-digit.active {
      background: var(--red);
      box-shadow: 0 0 20px rgba(227, 24, 55, 0.5);
      transform: scale(1.1);
    }

    .pin-digit.error {
      background: #ef4444;
      animation: shake 0.4s ease;
    }

    .pin-digit.success {
      background: var(--green);
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-6px); }
      40%, 80% { transform: translateX(6px); }
    }

    .pin-pad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    .pin-btn {
      width: 75px;
      height: 75px;
      border-radius: 50%;
      border: none;
      background: #111;
      color: var(--text);
      font-size: 32px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.1s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
      -webkit-user-select: none;
      user-select: none;
    }

    .pin-btn:active {
      background: var(--red);
      transform: scale(0.92);
    }

    .pin-btn.empty { visibility: hidden; }
    .pin-btn.delete { font-size: 24px; color: var(--text-dim); }
    .pin-btn.delete:active { background: #333; color: var(--text); }

    /* ===== DASHBOARD ===== */
    #dashboard {
      display: none;
      height: 100%;
      flex-direction: column;
    }

    #dashboard.active { display: flex; }

    /* Header with Tabs */
    .dash-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 20px;
      background: var(--card);
      border-bottom: 1px solid var(--border);
    }

    .dash-header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .dash-header-left img {
      width: 36px;
      height: 36px;
      border-radius: 8px;
    }

    .header-tabs {
      display: flex;
      gap: 4px;
      background: #111;
      padding: 4px;
      border-radius: 10px;
    }

    .header-tab {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      background: transparent;
      color: var(--text-dim);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .header-tab:hover {
      color: var(--text);
    }

    .header-tab.active {
      background: var(--red);
      color: white;
    }

    .dash-header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sound-btn {
      padding: 8px 14px;
      border-radius: 20px;
      background: var(--green);
      border: none;
      color: #000;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }

    .sound-btn.off {
      background: #333;
      color: var(--text-dim);
    }

    .time {
      font-size: 14px;
      color: var(--text-dim);
      font-variant-numeric: tabular-nums;
    }

    /* Views */
    .view {
      display: none;
      flex: 1;
      overflow: hidden;
    }

    .view.active {
      display: flex;
    }

    /* ===== QUEUE VIEW ===== */
    #queueView {
      flex-direction: row;
    }

    .dash-queue {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .queue-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .queue-header h2 {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .queue-count {
      background: var(--red);
      color: #fff;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
    }

    .queue-empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-dim);
    }

    .queue-empty-icon {
      font-size: 40px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .queue-item {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .queue-item-info h3 {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .queue-item-meta {
      display: flex;
      align-items: center;
      gap: 14px;
      font-size: 13px;
      color: var(--text-dim);
    }

    .queue-flavor {
      background: #1a1a1a;
      padding: 4px 10px;
      border-radius: 6px;
    }

    .btn-done {
      padding: 12px 24px;
      border-radius: 10px;
      background: var(--green);
      border: none;
      color: #000;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.1s;
    }

    .btn-done:active { transform: scale(0.95); }

    /* Sidebar */
    .dash-sidebar {
      width: 320px;
      background: var(--card);
      border-left: 1px solid var(--border);
      padding: 20px;
      overflow-y: auto;
    }

    @media (max-width: 900px) {
      .dash-sidebar { display: none; }
    }

    .sidebar-section {
      margin-bottom: 28px;
    }

    .sidebar-section h3 {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-dim);
      margin-bottom: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .inv-item { margin-bottom: 14px; }

    .inv-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 14px;
    }

    .inv-bar {
      height: 6px;
      background: #222;
      border-radius: 3px;
      overflow: hidden;
    }

    .inv-fill {
      height: 100%;
      background: var(--green);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .inv-fill.low { background: var(--yellow); }
    .inv-fill.critical { background: #ef4444; }
    .inv-count.low { color: var(--yellow); }
    .inv-count.critical { color: #ef4444; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .stat-box {
      background: #111;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-dim);
      text-transform: uppercase;
      margin-top: 4px;
    }

    /* ===== ANALYTICS VIEW ===== */
    #analyticsView {
      flex-direction: column;
      overflow-y: auto;
      padding: 20px;
    }

    .analytics-grid {
      display: grid;
      gap: 16px;
      margin-bottom: 20px;
    }

    .analytics-grid.cols-4 { grid-template-columns: repeat(4, 1fr); }
    .analytics-grid.cols-3 { grid-template-columns: repeat(3, 1fr); }
    .analytics-grid.cols-2 { grid-template-columns: repeat(2, 1fr); }

    @media (max-width: 1000px) {
      .analytics-grid.cols-4 { grid-template-columns: repeat(2, 1fr); }
      .analytics-grid.cols-3 { grid-template-columns: 1fr; }
      .analytics-grid.cols-2 { grid-template-columns: 1fr; }
    }

    .a-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
    }

    .a-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .a-card-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .a-card-badge {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 6px;
      background: #111;
      color: var(--text-dim);
    }

    /* KPI Cards */
    .kpi-card {
      text-align: center;
      padding: 24px 16px;
    }

    .kpi-icon { font-size: 28px; margin-bottom: 8px; }
    .kpi-value { font-size: 36px; font-weight: 700; letter-spacing: -1px; }
    .kpi-label { font-size: 13px; color: var(--text-dim); margin-top: 4px; }

    .kpi-change {
      display: inline-block;
      font-size: 12px;
      font-weight: 500;
      padding: 3px 8px;
      border-radius: 12px;
      margin-top: 8px;
    }

    .kpi-change.up { background: rgba(34, 197, 94, 0.15); color: var(--green); }
    .kpi-change.down { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

    /* Chart container */
    .chart-wrap { height: 220px; position: relative; }

    /* Hot leads list */
    .hot-lead {
      background: #111;
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 10px;
      border-left: 3px solid var(--green);
    }

    .hot-lead.hot { border-left-color: var(--red); }
    .hot-lead.warm { border-left-color: var(--yellow); }

    .hot-lead-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .hot-lead-name { font-size: 14px; font-weight: 600; }

    .hot-lead-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .hot-lead-badge.hot { background: var(--red); color: white; }
    .hot-lead-badge.warm { background: var(--yellow); color: #000; }

    .hot-lead-company { font-size: 12px; color: var(--text-dim); }

    .hot-lead-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 8px;
    }

    .hot-lead-tag {
      font-size: 10px;
      padding: 2px 6px;
      background: var(--card);
      border-radius: 4px;
      color: var(--text-dim);
    }

    /* Progress bars */
    .goal-item { margin-bottom: 16px; }

    .goal-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .goal-bar {
      height: 8px;
      background: #111;
      border-radius: 4px;
      overflow: hidden;
    }

    .goal-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    /* Funnel */
    .funnel-stage {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px;
      background: #111;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    .funnel-icon { font-size: 24px; }
    .funnel-info { flex: 1; }
    .funnel-label { font-size: 12px; color: var(--text-dim); }
    .funnel-value { font-size: 22px; font-weight: 700; }
    .funnel-rate { font-size: 16px; font-weight: 600; }

    /* Scroll list */
    .scroll-list {
      max-height: 300px;
      overflow-y: auto;
    }

    /* Export button */
    .export-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: var(--red);
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
    }

    /* Alert popup */
    #alertPopup {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    #alertPopup.active { display: flex; }

    .alert-card {
      background: var(--card);
      border: 2px solid var(--green);
      border-radius: 24px;
      padding: 40px;
      text-align: center;
      animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      box-shadow: 0 0 60px rgba(34, 197, 94, 0.3);
    }

    @keyframes popIn {
      from { transform: scale(0.8); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    .alert-icon { font-size: 56px; margin-bottom: 16px; }
    .alert-title { font-size: 24px; font-weight: 700; color: var(--green); margin-bottom: 20px; }
    .alert-name { font-size: 22px; font-weight: 600; margin-bottom: 8px; }
    .alert-flavor { font-size: 18px; color: var(--text-dim); margin-bottom: 24px; }

    .alert-dismiss {
      padding: 14px 32px;
      border-radius: 12px;
      background: var(--green);
      border: none;
      color: #000;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Loading spinner */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 150px;
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-top-color: var(--red);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

<!-- PIN Screen -->
<div id="pinScreen">
  <div class="pin-brand">
    <img src="/logo.png" alt="CanadaMade" class="pin-logo">
    <h1>CanadaMade</h1>
    <p>Gulf Expo Dubai 2026</p>
  </div>

  <div class="pin-display">
    <div class="pin-digit" id="d0"></div>
    <div class="pin-digit" id="d1"></div>
    <div class="pin-digit" id="d2"></div>
    <div class="pin-digit" id="d3"></div>
  </div>

  <div class="pin-pad" id="pinPad">
    <button class="pin-btn" data-val="1">1</button>
    <button class="pin-btn" data-val="2">2</button>
    <button class="pin-btn" data-val="3">3</button>
    <button class="pin-btn" data-val="4">4</button>
    <button class="pin-btn" data-val="5">5</button>
    <button class="pin-btn" data-val="6">6</button>
    <button class="pin-btn" data-val="7">7</button>
    <button class="pin-btn" data-val="8">8</button>
    <button class="pin-btn" data-val="9">9</button>
    <button class="pin-btn empty"></button>
    <button class="pin-btn" data-val="0">0</button>
    <button class="pin-btn delete" data-val="del">‚Üê</button>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboard">
  <header class="dash-header">
    <div class="dash-header-left">
      <img src="/logo.png" alt="">
      <div class="header-tabs">
        <button class="header-tab active" data-view="queue">Queue</button>
        <button class="header-tab" data-view="analytics">Analytics</button>
      </div>
    </div>
    <div class="dash-header-right">
      <button class="sound-btn" id="soundBtn">üîî ON</button>
      <span class="time" id="clock">--:--</span>
    </div>
  </header>

  <!-- Queue View -->
  <div id="queueView" class="view active">
    <section class="dash-queue">
      <div class="queue-header">
        <h2>üìã Pickup Queue <span class="queue-count" id="queueCount">0</span></h2>
      </div>
      <div id="queueList">
        <div class="queue-empty">
          <div class="queue-empty-icon">‚ú®</div>
          <p>No pickups waiting</p>
        </div>
      </div>
    </section>

    <aside class="dash-sidebar">
      <div class="sidebar-section">
        <h3>üì¶ Inventory</h3>
        <div id="invList"></div>
      </div>
      <div class="sidebar-section">
        <h3>üìä Today</h3>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-value" id="statVerified">0</div>
            <div class="stat-label">Verified</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="statCollected">0</div>
            <div class="stat-label">Collected</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="statWaiting">0</div>
            <div class="stat-label">Waiting</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="statRate">0%</div>
            <div class="stat-label">Rate</div>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Analytics View -->
  <div id="analyticsView" class="view">
    <!-- KPI Row -->
    <div class="analytics-grid cols-4">
      <div class="a-card kpi-card">
        <div class="kpi-icon">üìä</div>
        <div class="kpi-value" id="kpiTotal">-</div>
        <div class="kpi-label">Total Leads</div>
        <span class="kpi-change" id="kpiTotalChange">-</span>
      </div>
      <div class="a-card kpi-card">
        <div class="kpi-icon">‚úÖ</div>
        <div class="kpi-value" id="kpiVerified">-</div>
        <div class="kpi-label">Verified</div>
        <span class="kpi-change" id="kpiVerifiedChange">-</span>
      </div>
      <div class="a-card kpi-card">
        <div class="kpi-icon">üî•</div>
        <div class="kpi-value" id="kpiHot">-</div>
        <div class="kpi-label">Hot Leads</div>
      </div>
      <div class="a-card kpi-card">
        <div class="kpi-icon">üéØ</div>
        <div class="kpi-value" id="kpiGoal">-</div>
        <div class="kpi-label">Daily Goal</div>
        <span class="kpi-change" id="kpiGoalRemaining">-</span>
      </div>
    </div>

    <!-- Goals -->
    <div class="analytics-grid cols-2">
      <div class="a-card">
        <div class="a-card-header">
          <span class="a-card-title">üéØ Goal Progress</span>
          <a href="/.netlify/functions/export-csv" class="export-btn" download>‚Üì Export CSV</a>
        </div>
        <div id="goalsContainer"><div class="loading"><div class="spinner"></div></div></div>
      </div>
      <div class="a-card">
        <div class="a-card-header">
          <span class="a-card-title">üìà Conversion Funnel</span>
        </div>
        <div id="funnelContainer"><div class="loading"><div class="spinner"></div></div></div>
      </div>
    </div>

    <!-- Charts -->
    <div class="analytics-grid cols-2">
      <div class="a-card">
        <div class="a-card-header">
          <span class="a-card-title">üçü Flavor Rankings</span>
        </div>
        <div class="chart-wrap"><canvas id="flavorChart"></canvas></div>
      </div>
      <div class="a-card">
        <div class="a-card-header">
          <span class="a-card-title">üåç Top Countries</span>
        </div>
        <div class="chart-wrap"><canvas id="countryChart"></canvas></div>
      </div>
    </div>

    <!-- Hot Leads & Hourly -->
    <div class="analytics-grid cols-2">
      <div class="a-card">
        <div class="a-card-header">
          <span class="a-card-title">üî• Hot Leads</span>
          <span class="a-card-badge" id="hotLeadsBadge">0 leads</span>
        </div>
        <div class="scroll-list" id="hotLeadsContainer"><div class="loading"><div class="spinner"></div></div></div>
      </div>
      <div class="a-card">
        <div class="a-card-header">
          <span class="a-card-title">‚è∞ Leads by Hour</span>
          <span class="a-card-badge">Dubai Time</span>
        </div>
        <div class="chart-wrap"><canvas id="hourlyChart"></canvas></div>
      </div>
    </div>
  </div>
</div>

<!-- Alert Popup -->
<div id="alertPopup">
  <div class="alert-card">
    <div class="alert-icon">üîî</div>
    <div class="alert-title">NEW PICKUP</div>
    <div class="alert-name" id="alertName">-</div>
    <div class="alert-flavor" id="alertFlavor">-</div>
    <button class="alert-dismiss" id="alertDismiss">View Queue</button>
  </div>
</div>

<script>
// Config
const SUPABASE_URL = 'https://iaabsenvpwyqakvkypeq.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlhYWJzZW52cHd5cWFrdmt5cGVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY0MTg1MDAsImV4cCI6MjA1MTk5NDUwMH0.L3bH-GrCleqkIoc7TQ_d5uKRrmqDLwcZ7nA2dPNqUrc';
const API_BASE = '/.netlify/functions';
const PIN = '2026';

// State
let db;
let pin = '';
let soundOn = true;
let queue = [];
let inventory = [];
let audioCtx;
let flavorChart, countryChart, hourlyChart;
let analyticsLoaded = false;

// Init
document.addEventListener('DOMContentLoaded', init);

function init() {
  db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  updateClock();
  setInterval(updateClock, 1000);

  document.getElementById('pinPad').addEventListener('click', handlePinClick);
  document.getElementById('soundBtn').addEventListener('click', toggleSound);
  document.getElementById('alertDismiss').addEventListener('click', hideAlert);

  // Tab switching
  document.querySelectorAll('.header-tab').forEach(tab => {
    tab.addEventListener('click', () => switchView(tab.dataset.view));
  });

  if (sessionStorage.getItem('staff_auth') === '1') {
    openDashboard();
  }

  document.body.addEventListener('touchstart', initAudio, { once: true });
  document.body.addEventListener('click', initAudio, { once: true });
}

function initAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

// Tab switching
function switchView(view) {
  document.querySelectorAll('.header-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

  document.querySelector(`.header-tab[data-view="${view}"]`).classList.add('active');
  document.getElementById(`${view}View`).classList.add('active');

  if (view === 'analytics' && !analyticsLoaded) {
    loadAnalytics();
    analyticsLoaded = true;
  }
}

// ===== PIN =====
function handlePinClick(e) {
  const btn = e.target.closest('.pin-btn');
  if (!btn || btn.classList.contains('empty')) return;

  const val = btn.dataset.val;
  playClick();

  if (val === 'del') {
    pin = pin.slice(0, -1);
  } else if (pin.length < 4) {
    pin += val;
  }

  updateDots();

  if (pin.length === 4) {
    setTimeout(checkPin, 150);
  }
}

function updateDots() {
  for (let i = 0; i < 4; i++) {
    const dot = document.getElementById('d' + i);
    dot.classList.toggle('active', i < pin.length);
    dot.classList.remove('error', 'success');
  }
}

function checkPin() {
  if (pin === PIN) {
    playSuccess();
    document.querySelectorAll('.pin-digit').forEach(d => {
      d.classList.remove('active');
      d.classList.add('success');
    });
    sessionStorage.setItem('staff_auth', '1');
    setTimeout(openDashboard, 400);
  } else {
    playError();
    document.querySelectorAll('.pin-digit').forEach(d => d.classList.add('error'));
    setTimeout(() => { pin = ''; updateDots(); }, 400);
  }
}

function openDashboard() {
  document.getElementById('pinScreen').classList.add('hidden');
  document.getElementById('dashboard').classList.add('active');
  loadData();
  setupRealtime();
}

// ===== SOUND =====
function playClick() {
  if (!soundOn || !audioCtx) return;
  try {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.value = 600;
    osc.type = 'sine';
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.1);
  } catch(e) {}
}

function playSuccess() {
  if (!soundOn || !audioCtx) return;
  try {
    [800, 1000, 1200].forEach((freq, i) => {
      setTimeout(() => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.frequency.value = freq;
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.15, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.15);
      }, i * 100);
    });
  } catch(e) {}
}

function playError() {
  if (!soundOn || !audioCtx) return;
  try {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.frequency.value = 200;
    osc.type = 'square';
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
    osc.start();
    osc.stop(audioCtx.currentTime + 0.3);
  } catch(e) {}
}

function playNotification() {
  if (!soundOn || !audioCtx) return;
  try {
    [880, 1100, 880, 1100].forEach((freq, i) => {
      setTimeout(() => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.frequency.value = freq;
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.15);
      }, i * 150);
    });
  } catch(e) {}
}

function toggleSound() {
  soundOn = !soundOn;
  const btn = document.getElementById('soundBtn');
  btn.textContent = soundOn ? 'üîî ON' : 'üîï OFF';
  btn.classList.toggle('off', !soundOn);
  if (soundOn) playClick();
}

// ===== QUEUE DATA =====
async function loadData() {
  await Promise.all([loadQueue(), loadInventory(), loadStats()]);
}

async function loadQueue() {
  const today = new Date().toISOString().split('T')[0];
  const { data } = await db
    .from('leads')
    .select('*')
    .eq('verified', true)
    .eq('booth_notified', false)
    .gte('created_at', today)
    .order('created_at', { ascending: true });

  queue = data || [];
  renderQueue();
}

async function loadInventory() {
  const { data, error } = await db.from('inventory').select('*').order('display_name');

  if (error || !data || data.length === 0) {
    inventory = [
      { flavor: 'barbeque', display_name: 'Barbeque', emoji: 'üçñ', current_stock: 200, initial_stock: 200 },
      { flavor: 'dill-pickle', display_name: 'Dill Pickle', emoji: 'ü•í', current_stock: 200, initial_stock: 200 },
      { flavor: 'ketchup', display_name: 'Ketchup', emoji: 'üçÖ', current_stock: 200, initial_stock: 200 },
      { flavor: 'salt-vinegar', display_name: 'Salt & Vinegar', emoji: 'üßÇ', current_stock: 200, initial_stock: 200 },
      { flavor: 'sea-salt', display_name: 'Sea Salt', emoji: 'üåä', current_stock: 200, initial_stock: 200 }
    ];
  } else {
    inventory = data;
  }
  renderInventory();
}

async function loadStats() {
  const today = new Date().toISOString().split('T')[0];
  const { data } = await db
    .from('leads')
    .select('verified, booth_notified')
    .gte('created_at', today);

  const verified = data?.filter(l => l.verified).length || 0;
  const collected = data?.filter(l => l.booth_notified).length || 0;
  const waiting = verified - collected;
  const rate = verified > 0 ? Math.round((collected / verified) * 100) : 0;

  document.getElementById('statVerified').textContent = verified;
  document.getElementById('statCollected').textContent = collected;
  document.getElementById('statWaiting').textContent = waiting;
  document.getElementById('statRate').textContent = rate + '%';
}

function renderQueue() {
  const container = document.getElementById('queueList');
  document.getElementById('queueCount').textContent = queue.length;

  if (queue.length === 0) {
    container.innerHTML = `<div class="queue-empty"><div class="queue-empty-icon">‚ú®</div><p>No pickups waiting</p></div>`;
    return;
  }

  container.innerHTML = queue.map(lead => {
    const mins = Math.floor((Date.now() - new Date(lead.created_at)) / 60000);
    const inv = inventory.find(i => i.flavor === lead.flavor) || {};
    return `
      <div class="queue-item">
        <div class="queue-item-info">
          <h3>${lead.first_name} ${lead.last_name || ''}</h3>
          <div class="queue-item-meta">
            <span class="queue-flavor">${inv.emoji || 'üçü'} ${inv.display_name || lead.flavor}</span>
            <span>üìû ${lead.phone || lead.whatsapp_number || '-'}</span>
            <span>‚è± ${mins}m</span>
          </div>
        </div>
        <button class="btn-done" onclick="markDone('${lead.id}')">‚úì Done</button>
      </div>
    `;
  }).join('');
}

function renderInventory() {
  const container = document.getElementById('invList');
  container.innerHTML = inventory.map(item => {
    const pct = Math.round((item.current_stock / item.initial_stock) * 100);
    const status = pct <= 10 ? 'critical' : pct <= 25 ? 'low' : '';
    return `
      <div class="inv-item">
        <div class="inv-row">
          <span>${item.emoji} ${item.display_name}</span>
          <span class="inv-count ${status}">${item.current_stock}</span>
        </div>
        <div class="inv-bar"><div class="inv-fill ${status}" style="width:${pct}%"></div></div>
      </div>
    `;
  }).join('');
}

// ===== REALTIME =====
function setupRealtime() {
  db.channel('leads')
    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'leads' }, payload => {
      if (payload.new.verified && !payload.new.booth_notified) {
        queue.unshift(payload.new);
        renderQueue();
        loadStats();
        showAlert(payload.new);
        playNotification();
      }
    })
    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'leads' }, payload => {
      if (payload.new.booth_notified) {
        queue = queue.filter(l => l.id !== payload.new.id);
        renderQueue();
        loadStats();
      } else if (payload.new.verified && !payload.new.booth_notified) {
        if (!queue.find(l => l.id === payload.new.id)) {
          queue.unshift(payload.new);
          renderQueue();
          loadStats();
          showAlert(payload.new);
          playNotification();
        }
      }
    })
    .subscribe();
}

// ===== ACTIONS =====
async function markDone(id) {
  await db.from('leads').update({ booth_notified: true }).eq('id', id);
  queue = queue.filter(l => l.id !== id);
  renderQueue();
  loadStats();
  playSuccess();
}

function showAlert(lead) {
  const inv = inventory.find(i => i.flavor === lead.flavor) || {};
  document.getElementById('alertName').textContent = `${lead.first_name} ${lead.last_name || ''}`;
  document.getElementById('alertFlavor').textContent = `${inv.emoji || 'üçü'} ${inv.display_name || lead.flavor}`;
  document.getElementById('alertPopup').classList.add('active');
  setTimeout(hideAlert, 8000);
}

function hideAlert() {
  document.getElementById('alertPopup').classList.remove('active');
}

function updateClock() {
  document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
}

// ===== ANALYTICS =====
async function fetchAPI(endpoint) {
  try {
    const res = await fetch(`${API_BASE}/${endpoint}`);
    return await res.json();
  } catch (e) {
    console.error(`Error fetching ${endpoint}:`, e);
    return null;
  }
}

async function loadAnalytics() {
  await Promise.all([
    loadGoalTracker(),
    loadFunnel(),
    loadFlavorChart(),
    loadCountryChart(),
    loadHourlyChart(),
    loadHotLeads(),
    loadComparison()
  ]);
}

async function loadGoalTracker() {
  const data = await fetchAPI('goal-tracker');
  if (!data?.success) return;

  document.getElementById('kpiTotal').textContent = data.goals.total_leads.current;
  document.getElementById('kpiGoal').textContent = data.goals.daily_leads.percentage + '%';
  document.getElementById('kpiGoalRemaining').textContent = `${data.goals.daily_leads.remaining} to go`;
  document.getElementById('kpiGoalRemaining').className = 'kpi-change';

  document.getElementById('goalsContainer').innerHTML = `
    <div class="goal-item">
      <div class="goal-header"><span>Daily Leads</span><span>${data.goals.daily_leads.current}/${data.goals.daily_leads.goal}</span></div>
      <div class="goal-bar"><div class="goal-fill" style="width:${data.goals.daily_leads.percentage}%;background:var(--red)"></div></div>
    </div>
    <div class="goal-item">
      <div class="goal-header"><span>Daily Verified</span><span>${data.goals.daily_verified.current}/${data.goals.daily_verified.goal}</span></div>
      <div class="goal-bar"><div class="goal-fill" style="width:${data.goals.daily_verified.percentage}%;background:var(--green)"></div></div>
    </div>
    <div class="goal-item">
      <div class="goal-header"><span>Wholesale</span><span>${data.goals.daily_wholesale.current}/${data.goals.daily_wholesale.goal}</span></div>
      <div class="goal-bar"><div class="goal-fill" style="width:${data.goals.daily_wholesale.percentage}%;background:var(--blue)"></div></div>
    </div>
    <div class="goal-item">
      <div class="goal-header"><span>Campaign Total</span><span>${data.goals.total_leads.current}/${data.goals.total_leads.goal}</span></div>
      <div class="goal-bar"><div class="goal-fill" style="width:${data.goals.total_leads.percentage}%;background:var(--purple)"></div></div>
    </div>
  `;
}

async function loadFunnel() {
  const data = await fetchAPI('conversion-funnel');
  if (!data?.success) return;

  document.getElementById('kpiVerified').textContent = data.funnel.stage_2_verified.count;

  document.getElementById('funnelContainer').innerHTML = `
    <div class="funnel-stage"><div class="funnel-icon">üìù</div><div class="funnel-info"><div class="funnel-label">Registered</div><div class="funnel-value">${data.funnel.stage_1_registered.count}</div></div><div class="funnel-rate">100%</div></div>
    <div class="funnel-stage"><div class="funnel-icon">‚úÖ</div><div class="funnel-info"><div class="funnel-label">Verified</div><div class="funnel-value">${data.funnel.stage_2_verified.count}</div></div><div class="funnel-rate" style="color:var(--green)">${data.funnel.stage_2_verified.percentage}</div></div>
    <div class="funnel-stage"><div class="funnel-icon">üéÅ</div><div class="funnel-info"><div class="funnel-label">Collected</div><div class="funnel-value">${data.funnel.stage_3_collected.count}</div></div><div class="funnel-rate" style="color:var(--blue)">${data.funnel.stage_3_collected.percentage}</div></div>
  `;
}

async function loadFlavorChart() {
  const data = await fetchAPI('flavor-rankings');
  if (!data?.success) return;

  const ctx = document.getElementById('flavorChart').getContext('2d');
  if (flavorChart) flavorChart.destroy();

  flavorChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: data.rankings.map(r => r.flavor),
      datasets: [{ data: data.rankings.map(r => r.count), backgroundColor: ['#E31837', '#22c55e', '#eab308', '#3b82f6', '#8b5cf6'], borderWidth: 0 }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#888', padding: 12, font: { size: 12 } } } } }
  });
}

async function loadCountryChart() {
  const data = await fetchAPI('leads-by-country');
  if (!data?.success) return;

  const ctx = document.getElementById('countryChart').getContext('2d');
  if (countryChart) countryChart.destroy();

  const top8 = data.rankings.slice(0, 8);

  countryChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: top8.map(c => c.country),
      datasets: [{ data: top8.map(c => c.total), backgroundColor: '#3b82f6', borderRadius: 4 }]
    },
    options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#1a1a1a' }, ticks: { color: '#888' } }, y: { grid: { display: false }, ticks: { color: '#888', font: { size: 11 } } } } }
  });
}

async function loadHourlyChart() {
  const data = await fetchAPI('leads-by-hour');
  if (!data?.success) return;

  const ctx = document.getElementById('hourlyChart').getContext('2d');
  if (hourlyChart) hourlyChart.destroy();

  const expoHours = data.hourly_breakdown.filter(h => h.hour >= 8 && h.hour <= 20);

  hourlyChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: expoHours.map(h => h.label),
      datasets: [{ data: expoHours.map(h => h.count), backgroundColor: '#E31837', borderRadius: 4 }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#888', font: { size: 10 } } }, y: { grid: { color: '#1a1a1a' }, ticks: { color: '#888' } } } }
  });
}

async function loadHotLeads() {
  const data = await fetchAPI('hot-leads');
  if (!data?.success) return;

  document.getElementById('kpiHot').textContent = data.summary.hot_leads;
  document.getElementById('hotLeadsBadge').textContent = `${data.summary.hot_leads + data.summary.warm_leads} priority`;

  const allHot = [...data.hot_leads, ...data.warm_leads].slice(0, 8);

  if (allHot.length === 0) {
    document.getElementById('hotLeadsContainer').innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-dim)">No hot leads yet</div>';
    return;
  }

  document.getElementById('hotLeadsContainer').innerHTML = allHot.map(lead => `
    <div class="hot-lead ${lead.priority.toLowerCase()}">
      <div class="hot-lead-header">
        <span class="hot-lead-name">${lead.name}</span>
        <span class="hot-lead-badge ${lead.priority.toLowerCase()}">${lead.priority}</span>
      </div>
      <div class="hot-lead-company">${lead.company} ¬∑ ${lead.job_title}</div>
      <div class="hot-lead-tags">${lead.reasons.slice(0, 3).map(r => `<span class="hot-lead-tag">${r}</span>`).join('')}</div>
    </div>
  `).join('');
}

async function loadComparison() {
  const data = await fetchAPI('today-vs-yesterday');
  if (!data?.success) return;

  const change = data.comparison.leads.change;
  document.getElementById('kpiTotalChange').textContent = change;
  document.getElementById('kpiTotalChange').className = `kpi-change ${parseFloat(change) >= 0 ? 'up' : 'down'}`;

  const vChange = data.comparison.verified.change;
  document.getElementById('kpiVerifiedChange').textContent = vChange;
  document.getElementById('kpiVerifiedChange').className = `kpi-change ${parseFloat(vChange) >= 0 ? 'up' : 'down'}`;
}
</script>
</body>
</html>
